suite: test archestra platform -- Secret
templates:
  - secret.yaml
tests:
  - it: should create auth secret with keep policy and auth-secret key
    asserts:
      - isKind:
          of: Secret
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform-auth$
      - equal:
          path: type
          value: Opaque
      - equal:
          path: metadata.annotations["helm.sh/resource-policy"]
          value: keep
      - isNotEmpty:
          path: data["auth-secret"]

  - it: should not include database-url when external_database_url is not provided
    set:
      postgresql.external_database_url: null
    asserts:
      - isNull:
          path: data["database-url"]

  - it: should include database-url when external_database_url is provided
    set:
      postgresql.external_database_url: postgresql://external:pass@external-host:5432/externaldb
    asserts:
      - isNotEmpty:
          path: data["database-url"]
