suite: test archestra platform -- Secret
templates:
  - secret.yaml
tests:
  - it: should create auth secret with keep policy and auth-secret key
    asserts:
      - isKind:
          of: Secret
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform-auth$
      - equal:
          path: type
          value: Opaque
      - equal:
          path: metadata.annotations["helm.sh/resource-policy"]
          value: keep
      - isNotEmpty:
          path: data["auth-secret"]

  - it: should not include database-url when external_database_url is not provided
    set:
      postgresql.external_database_url: null
    asserts:
      - isNull:
          path: data["database-url"]

  - it: should include database-url when external_database_url is provided
    set:
      postgresql.external_database_url: postgresql://external:pass@external-host:5432/externaldb
    asserts:
      - isNotEmpty:
          path: data["database-url"]

  # Sensitive environment variable tests
  - it: should not include sensitive env vars in secret when not provided
    set:
      archestra.env: {}
    asserts:
      - isNull:
          path: data["archestra-auth-admin-password"]
      - isNull:
          path: data["archestra-otel-exporter-otlp-auth-password"]
      - isNull:
          path: data["archestra-otel-exporter-otlp-auth-bearer"]
      - isNull:
          path: data["archestra-metrics-secret"]
      - isNull:
          path: data["archestra-hashicorp-vault-token"]

  - it: should include ARCHESTRA_AUTH_ADMIN_PASSWORD in secret when provided
    set:
      archestra.env:
        ARCHESTRA_AUTH_ADMIN_PASSWORD: "my-secure-admin-password"
    asserts:
      - isNotEmpty:
          path: data["archestra-auth-admin-password"]

  - it: should include ARCHESTRA_OTEL_EXPORTER_OTLP_AUTH_PASSWORD in secret when provided
    set:
      archestra.env:
        ARCHESTRA_OTEL_EXPORTER_OTLP_AUTH_PASSWORD: "otel-password-123"
    asserts:
      - isNotEmpty:
          path: data["archestra-otel-exporter-otlp-auth-password"]

  - it: should include ARCHESTRA_OTEL_EXPORTER_OTLP_AUTH_BEARER in secret when provided
    set:
      archestra.env:
        ARCHESTRA_OTEL_EXPORTER_OTLP_AUTH_BEARER: "bearer-token-xyz"
    asserts:
      - isNotEmpty:
          path: data["archestra-otel-exporter-otlp-auth-bearer"]

  - it: should include ARCHESTRA_METRICS_SECRET in secret when provided
    set:
      archestra.env:
        ARCHESTRA_METRICS_SECRET: "metrics-secret-token"
    asserts:
      - isNotEmpty:
          path: data["archestra-metrics-secret"]

  - it: should include ARCHESTRA_HASHICORP_VAULT_TOKEN in secret when provided
    set:
      archestra.env:
        ARCHESTRA_HASHICORP_VAULT_TOKEN: "vault-token-abc123"
    asserts:
      - isNotEmpty:
          path: data["archestra-hashicorp-vault-token"]

  - it: should include multiple sensitive env vars when provided together
    set:
      archestra.env:
        ARCHESTRA_AUTH_ADMIN_PASSWORD: "admin-password"
        ARCHESTRA_METRICS_SECRET: "metrics-secret"
        ARCHESTRA_HASHICORP_VAULT_TOKEN: "vault-token"
    asserts:
      - isNotEmpty:
          path: data["archestra-auth-admin-password"]
      - isNotEmpty:
          path: data["archestra-metrics-secret"]
      - isNotEmpty:
          path: data["archestra-hashicorp-vault-token"]
      # These should still be null since not provided
      - isNull:
          path: data["archestra-otel-exporter-otlp-auth-password"]
      - isNull:
          path: data["archestra-otel-exporter-otlp-auth-bearer"]

  - it: should not include non-sensitive env vars in secret
    set:
      archestra.env:
        ARCHESTRA_API_BASE_URL: "https://api.example.com"
        ARCHESTRA_FRONTEND_URL: "https://frontend.example.com"
        ARCHESTRA_LOGGING_LEVEL: "debug"
    asserts:
      # Non-sensitive vars should not be stored in the secret
      - isNull:
          path: data["archestra-api-base-url"]
      - isNull:
          path: data["archestra-frontend-url"]
      - isNull:
          path: data["archestra-logging-level"]
