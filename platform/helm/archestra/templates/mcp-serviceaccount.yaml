{{- if .Values.archestra.orchestrator.kubernetes.mcpServerRbac.create }}
---
# ServiceAccount specifically for MCP servers that need Kubernetes API access
# This is used ONLY by the Kubernetes MCP server - other MCP servers use the default service account with no permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "archestra-platform.fullname" . }}-mcp-k8s-operator
  namespace: {{ .Values.archestra.orchestrator.kubernetes.namespace | default .Release.Namespace }}
  labels:
    {{- include "archestra-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: mcp-serviceaccount
---
# Role with minimal read-only permissions for basic Kubernetes inspection
# Grants only essential read permissions for the Kubernetes MCP server
# NOTE: Many write operations (create/update/delete) will not work with these minimal permissions
# Only granted to the mcp-k8s-operator service account, not to all MCP server pods
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "archestra-platform.fullname" . }}-mcp-server-operator
  namespace: {{ .Values.archestra.orchestrator.kubernetes.namespace | default .Release.Namespace }}
  labels:
    {{- include "archestra-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: mcp-serviceaccount
rules:
# Minimal read-only permissions for basic Kubernetes inspection
# Pods - read access only
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
# Pod logs - essential for debugging
- apiGroups: [""]
  resources: ["pods/log"]
  verbs: ["get"]
# Services - common resource to inspect
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list", "watch"]
# Deployments and workloads - common resources to inspect
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
  verbs: ["get", "list", "watch"]
# Events - useful for debugging
- apiGroups: [""]
  resources: ["events"]
  verbs: ["get", "list", "watch"]
---
# RoleBinding that grants the Role to the mcp-k8s-operator service account
# This is the critical security boundary - only pods that explicitly use this service account get K8s API access
# Permissions are restricted to the namespace only
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "archestra-platform.fullname" . }}-mcp-server-operator
  namespace: {{ .Values.archestra.orchestrator.kubernetes.namespace | default .Release.Namespace }}
  labels:
    {{- include "archestra-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: mcp-serviceaccount
subjects:
- kind: ServiceAccount
  name: {{ include "archestra-platform.fullname" . }}-mcp-k8s-operator
  namespace: {{ .Values.archestra.orchestrator.kubernetes.namespace | default .Release.Namespace }}
roleRef:
  kind: Role
  name: {{ include "archestra-platform.fullname" . }}-mcp-server-operator
  apiGroup: rbac.authorization.k8s.io
{{- end }}
